<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <UsingTask TaskName="Microsoft.MSBuild.LockFile.Tasks.LockFileToMSBuild2" AssemblyFile="$(MSBuildThisFileDirectory)bin\Debug\Microsoft.MSBuild.LockFile.Tasks.dll" />

  <PropertyGroup Condition="'$(ProjectLockFile)' == ''">
    <_ProjectSpecificProjectJsonFile>$(MSBuildProjectName).project.json</_ProjectSpecificProjectJsonFile>
    <ProjectLockFile Condition="Exists('$(_ProjectSpecificProjectJsonFile)')">$(MSBuildProjectName).project.lock.json</ProjectLockFile>
    <ProjectLockFile Condition="!Exists('$(_ProjectSpecificProjectJsonFile)')">project.lock.json</ProjectLockFile>

    <!-- Turn off NuGet Task -->
    <ResolveNuGetPackages>false</ResolveNuGetPackages>

    <!-- Flag LockFile Tasks -->
    <EnableLockFileToMSBuild Condition="'$(EnableLockFileToMSBuild)' == '' and '$(MSBuildProjectExtension)' != '.xproj'">true</EnableLockFileToMSBuild>
  </PropertyGroup>

  <!-- Add Targets to Dependency Lists, causing them to be triggered -->
  <PropertyGroup>
    <ResolveAssemblyReferencesDependsOn>$(ResolveAssemblyReferencesDependsOn);LockFileResolveReferences</ResolveAssemblyReferencesDependsOn>
    <PrepareResourcesDependsOn>$(PrepareResourcesDependsOn);LockFileResolveReferences</PrepareResourcesDependsOn>
    <_FindDependencies>false</_FindDependencies>
  </PropertyGroup>

  <!-- If a NuGetRuntimeIdentifier wasn't already specified, let's go generate it -->
  <PropertyGroup Condition="'$(NuGetRuntimeIdentifier)' == ''">
    <NuGetRuntimeIdentifier>$(_NuGetRuntimeIdentifierWithoutAot)</NuGetRuntimeIdentifier>
    <NuGetRuntimeIdentifier Condition="'$(UseDotNetNativeToolchain)' == 'true'">$(_NuGetRuntimeIdentifierWithoutAot)-aot</NuGetRuntimeIdentifier>
  </PropertyGroup>

  <!-- Turn off -->
  <!--<Target Name="ResolveNuGetPackageAssets" />-->
  <!--<Target Name="ResolveNuGetPackageAssets" />  
  <Target Name="RuntimeImplementationProjectOutputGroup" />
  <Target Name="ComputeNetCoreFrameworkInjectionParameters" />
  <Target Name="InjectNetCoreFramework" />-->
  <!--<Target Name="_CopyFilesMarkedCopyLocal" />-->

  <!-- Condition="'$(EnableLockFileToMSBuild)' == 'true' and Exists('$(ProjectLockFile)')" -->
  <Target Name="LockFileResolveReferences" DependsOnTargets="ComputeReferencesFromNuGetPackages;ComputeAnalyzersFromNuGetPackages">
    <Message Text="----[LockFileResolveReferences Called: POST ResolveNuGetPackageAssets]-------------" Importance="high" />
    <Message Text="ResolvedAnalyzers            -&gt;  @(Analyzer)" Importance="high" />
    <Message Text="ResolvedCopyLocalItems       -&gt;  @(ReferenceCopyLocalPaths)" Importance="high" />
    <Message Text="ResolvedReferences           -&gt;  @(_ReferencesFromNuGetPackages)" Importance="high" />
    <Message Text="ReferencedPackages           -&gt;  @(ReferencedNuGetPackages)" Importance="high" />
    <Message Text="ContentItems                 -&gt;  @(_NuGetContentItems)" Importance="high" />
    <Message Text="FileWrites                   -&gt;  @(FileWrites)" Importance="high" />
    <Message Text="Reference                   -&gt;  @(Reference)" Importance="high" />
    <Message Text="----------------------------------------------------------" Importance="high" />

    <!-- Temp: Remove what ResolveNuGetPackageAssets added -->
    <ItemGroup>
      <Reference Remove="@(_ReferencesFromNuGetPackages)" />
    </ItemGroup>
    <Message Text="Reference                   -&gt;  @(Reference)" Importance="high" />
    
    <!-- Add the references we computed -->
    <ItemGroup>
      <Reference Include="@(ResolvedCompileFileDefinitions)" />
    </ItemGroup>
    <Message Text="Reference                   -&gt;  @(Reference)" Importance="high" />
    
    <!-- Add the analyzers we computed -->
    <ItemGroup>
      <Analyzer Include="@(ResolvedAnalyzers)" />
      <!--<ReferenceCopyLocalPaths Include="@(ResolvedAnalyzers)" />-->
    </ItemGroup>
    <Message Text="ResolvedAnalyzers            -&gt;  @(Analyzer)" Importance="high" />

  </Target>
  
  <!-- Run the task -->
  <Target Name="RunLockFileToMSBuild">
    <Message Text="     -> (Raising Lock File: ProjectLockFile=$(ProjectLockFile))" Importance="high"/>

    <LockFileToMSBuild2
      ProjectLockFile="$(ProjectLockFile)">

      <Output TaskParameter="TargetDefinitions" ItemName="TargetDefinitions" />
      <Output TaskParameter="PackageDefinitions" ItemName="PackageDefinitions" />
      <Output TaskParameter="FileDefinitions" ItemName="FileDefinitions" />
      <Output TaskParameter="PackageDependencies" ItemName="PackageDependencies" />
      <Output TaskParameter="FileDependencies" ItemName="FileDependencies" />
    </LockFileToMSBuild2>

  </Target>

  <!-- Compute Resolved References -->
  <Target Name="ComputeReferencesFromNuGetPackages" DependsOnTargets="RunLockFileToMSBuild" Returns="ResolvedCompileFileDefinitions">
    <ItemGroup>
      <TFMFileItems Include="@(FileDependencies->WithMetadataValue('ParentTarget', '$(NuGetTargetMoniker)/$(NuGetRuntimeIdentifier)'))" />
      <TFMCompileFileItems Include="@(TFMFileItems->WithMetadataValue('FileGroup', 'CompileTimeAssembly'))" />
      
      <!-- Get corresponding file definitions -->
      <TFMCompileFileDefinitionsEx Include="@(FileDefinitions)" Exclude="@(TFMCompileFileItems)" />
      <TFMCompileFileDefinitions Include="@(FileDefinitions)" Exclude="@(TFMCompileFileDefinitionsEx)" />
      <ResolvedCompileFileDefinitions Include="%(TFMCompileFileDefinitions.ResolvedPath)" />

    </ItemGroup>
  </Target>

  <!-- Compute Resolved Analyzers -->
  <Target Name="ComputeAnalyzersFromNuGetPackages" DependsOnTargets="RunLockFileToMSBuild" Returns="ResolvedAnalyzers">
    <ItemGroup>
      <TFMFileItems Include="@(FileDependencies->WithMetadataValue('ParentTarget', '$(NuGetTargetMoniker)/$(NuGetRuntimeIdentifier)'))" />
      <TFMAnalyzerFileItems Include="@(TFMFileItems->WithMetadataValue('Analyzer', 'true'))" />

      <!-- Get corresponding file definitions -->
      <TFMCompileFileDefinitionsEx Include="@(FileDefinitions)" Exclude="@(TFMAnalyzerFileItems)" />
      <TFMCompileFileDefinitions Include="@(FileDefinitions)" Exclude="@(TFMCompileFileDefinitionsEx)" />
      <!--<ResolvedAnalyzers Include="%(TFMCompileFileDefinitions.ResolvedPath)" />-->

      <AnalyzerFiles Include="@(FileDefinitions->WithMetadataValue('Analyzer', 'true'))" />
      <ResolvedAnalyzers Include="%(AnalyzerFiles.ResolvedPath)" />
      
    </ItemGroup>
    <Message Text="AnalyzerFiles -&gt;  @(AnalyzerFiles)" Importance="high" />
  </Target>
  
</Project>